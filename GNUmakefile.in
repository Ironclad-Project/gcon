# GNUmakefile.in: Project's makefile template.
# Copyright (C) 2023 streaksu
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Targets and autoconf variables.
override SRCDIR   := @SRCDIR@
override BUILDDIR := @BUILDDIR@
override MKDIR_P  := @MKDIR_P@
override INSTALL  := @INSTALL@
override PREFIX   := @prefix@
override TARGET   := gcon

# Macros to make our build system still work from within paths with spaces
# or other special characters.
override SPACE := $(subst ,, )
MKESCAPE = $(subst $(SPACE),\ ,$(1))
SHESCAPE = $(subst ','\'',$(1))
OBJESCAPE = $(subst .a ,.a' ',$(subst .o ,.o' ',$(call SHESCAPE,$(1))))

override CFILES := $(shell cd '$(call SHESCAPE,$(SRCDIR))' && find . -type f -name '*.c')
override OBJ    := $(addprefix $(call MKESCAPE,$(BUILDDIR))/,$(CFILES:.c=.o))
override HEADER_DEPS := $(CFILES:.c=.d)

# Flags.
define DEFAULT_VAR =
    ifeq ($(origin $1),default)
        override $(1) := $(2)
    endif
    ifeq ($(origin $1),undefined)
        override $(1) := $(2)
    endif
endef
$(eval $(call DEFAULT_VAR,CC,@CC@))
CFLAGS   ?= @CFLAGS@ @WERROR@
CPPFLAGS ?= @CPPFLAGS@
LDFLAGS  ?= @LDFLAGS@

# Default target.
.PHONY: all
all: $(TARGET)

# Link rules for the final kernel executable.
$(TARGET): $(OBJ)
	$(CC) '$(call OBJESCAPE,$^)' $(CFLAGS) $(LDFLAGS) -o $@

# Include header dependencies.
-include $(HEADER_DEPS)

# Compilation rules for *.c files.
$(call MKESCAPE,$(BUILDDIR))/%.o: $(call MKESCAPE,$(SRCDIR))/%.c
	$(MKDIR_P) "$$(dirname '$(call SHESCAPE,$@)')"
	$(CC) $(CPPFLAGS) $(CFLAGS) -I '$(call SHESCAPE,$(SRCDIR))'/source -I '$(call SHESCAPE,$(SRCDIR))'/limine-terminal \
	-c '$(call SHESCAPE,$<)' -o $@

# Remove object files and the final executable.
.PHONY: clean
clean:
	rm -rf $(TARGET) $(OBJ) $(HEADER_DEPS)

.PHONY: distclean
distclean: clean
	rm -rf config.log config.status GNUmakefile

.PHONY: maintainer-clean
maintainer-clean: distclean
	cd '$(call SHESCAPE,$(SRCDIR))' && rm -rf limine-terminal configure build-aux *'~' autom4te.cache

.PHONY: install
install:
	$(INSTALL) -d $(DESTDIR)$(PREFIX)/bin
	$(INSTALL) $(TARGET) $(DESTDIR)$(PREFIX)/bin/

.PHONY: install-strip
install-strip:
	$(INSTALL) -d $(DESTDIR)$(PREFIX)/bin
	$(INSTALL) -s $(TARGET) $(DESTDIR)$(PREFIX)/bin/
